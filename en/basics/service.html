<!DOCTYPE html>
<html lang="en">
<head>
  <title>Service - Born to build better enterprise frameworks and apps</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" href="/css/index.css">

</head>
<body>
  <div class="nav" >
  <header>
    <a href="/" class="nav-logo leftpadding" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li>
        <form id="search-form">
          <input type="text" id="search-query" class="search-query st-default-search-input">
        </form>
      </li>
      <li><a href="intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      <!--
      <li class="translations">
        <a class="nav-link">Translations</a>
        <span class="arrow"></span>
        <ul class="dropdown-content">
          <li><a href="/">中文</a></li>
          <li><a href="/">English</a></li>
        </ul>
      </li>
      -->
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <article class="markdown-body">
    <h1>Service</h1>
    <p>Simply speaking, Service is an abstract layer which is used to encapsulate business logics in complex business circumstances, and this abstraction offers advantages as below:</p>
<ul>
<li>keep logics in Controller cleaner.</li>
<li>keep business logics independent, since the abstracted Service can be called by many Controllers repeatedly.</li>
<li>separate logics and representations, and make it easier to write test cases. Write test cases in detail referring to <a href="../core/unittest.html">here</a>.</li>
</ul>
<h2 id="usage-scenario"><a class="markdown-anchor" href="#usage-scenario">#</a> Usage Scenario</h2>
<ul>
<li>Processing complex data, e.g. information to be shown need to be got from databases, and should be processed in specific rules before it can be sent and seen by the user. Or when the process is done, the database should be updated.</li>
<li>Calling 3rd party services, e.g. getting Github information etc.</li>
</ul>
<h2 id="defining-service"><a class="markdown-anchor" href="#defining-service">#</a> Defining Service</h2>
<ul>
<li><code>app/service/user.js</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">app</span>.<span class="title">Service</span> </span>&#123;</div><div class="line">    * find(uid) &#123;</div><div class="line">      <span class="keyword">const</span> user = <span class="keyword">yield</span> <span class="keyword">this</span>.ctx.db.query(<span class="string">`select * from user where uid = <span class="subst">$&#123;uid&#125;</span>`</span>);</div><div class="line">      <span class="keyword">return</span> user;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> User;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="notes"><a class="markdown-anchor" href="#notes">#</a> Notes</h3>
<ul>
<li>Service files must be put under the <code>app/service</code> directory, and multi-level directory is supported, which can be accessed by cascading directory names.</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app/service/biz/user.js =&gt; ctx.service.biz.user</div><div class="line">app/service/sync_user.js =&gt; ctx.service.syncUser</div><div class="line">app/service/HackerNews.js =&gt; ctx.service.hackerNews</div></pre></td></tr></table></figure>
<ul>
<li>one Service file can only define one Class, which should be returned by <code>module.exports</code>.</li>
<li>Service should be defined in the Class way, and the parent class must be <code>app.Service</code>, which is passed as a parameter when initializing Service.</li>
<li>Service is not a singleton but a <strong>request level</strong> object, the framework lazy-initializes it when the request <code>ctx.service.xx</code> for the first time, so the context of current request can be got from this.ctx in Service.</li>
</ul>
<h3 id="service-ctx-in-detail"><a class="markdown-anchor" href="#service-ctx-in-detail">#</a> Service ctx in Detail</h3>
<p>To get the path chain of user request, the request context is injected by us during the Service initialization, so you are able to get context related information directly by <code>this.ctx</code> in methods. For detailed information about context, please refer to <a href="./extend.html#context">Context</a>.
With <code>ctx</code>, we can get various convenient attributes and methods encapsulated by the framework. For example we can use:</p>
<ul>
<li><code>this.ctx.curl</code> to make network calls.</li>
<li><code>this.ctx.service.otherService</code> to call other Services.</li>
<li><code>this.ctx.db</code> to make database calls etc, where db may be a module mounted by other plugins in advance.</li>
</ul>
<h1 id="using-service"><a class="markdown-anchor" href="#using-service">#</a> Using Service</h1>
<p>We begin to see how to use Service from a complete example below.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// app/router.js</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">  app.get(<span class="string">'/user/:id'</span>, <span class="string">'user.info'</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// app/controller/user.js</span></div><div class="line">exports.info = <span class="function"><span class="keyword">function</span>* (<span class="params">ctx</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> userId = ctx.params.id;</div><div class="line">  <span class="keyword">const</span> userInfo = <span class="keyword">yield</span> ctx.service.user.find(userId);</div><div class="line">  ctx.body = userInfo;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// app/service/user.js</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">app</span>.<span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="comment">// the constructor is not a must by default</span></div><div class="line">    <span class="comment">// constructor(ctx) &#123;</span></div><div class="line">    <span class="comment">//   super(ctx); if some processes should be made in the constructor, this statement is a must in order to use `this.ctx` later</span></div><div class="line">    <span class="comment">//   // get ctx through this.ctx directly</span></div><div class="line">    <span class="comment">//   // get app through this.app directly too</span></div><div class="line">    <span class="comment">// &#125;</span></div><div class="line"></div><div class="line">    * find(uid) &#123;</div><div class="line">      <span class="comment">// suppose we've got user's id and are going to get detailed user information from databases</span></div><div class="line">      <span class="keyword">const</span> user = <span class="keyword">yield</span> <span class="keyword">this</span>.ctx.db.query(<span class="string">`select * from user where uid = <span class="subst">$&#123;uid&#125;</span>`</span>);</div><div class="line"></div><div class="line">      <span class="comment">// suppose some complex processes should be made here, and demanded informations are returned then. </span></div><div class="line">      <span class="keyword">const</span> picture = <span class="keyword">yield</span> <span class="keyword">this</span>.getPicture(uid);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        name: user.user_name,</div><div class="line">        age: user.age,</div><div class="line">        picture,</div><div class="line">      &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    * getPicture(uid) &#123;</div><div class="line">      <span class="keyword">const</span> result = <span class="keyword">yield</span> <span class="keyword">this</span>.ctx.curl(<span class="string">`http://photoserver/uid=<span class="subst">$&#123;uid&#125;</span>`</span>, &#123;</div><div class="line">        dataType: <span class="string">'json'</span>,</div><div class="line">      &#125;);</div><div class="line">      <span class="keyword">return</span> result.data;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> User;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// curl http://127.0.0.1:7001/user/1234</span></div></pre></td></tr></table></figure>

  </article>
  <aside id="mobileAside" class="toc">
  <div class="mobile-menu">
    <ul><li><a href="intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li></ul>
  </div>
  <dl><dt>Guide</dt><dd><ul><li><a href="/en/intro/index.html">What is Egg?</a></li><li><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li><a href="/en/intro/quickstart.html">Quick Start</a></li></ul></dd><dt>Basis Function</dt><dd><ul><li><a href="/en/basics/structure.html">Directory Structure</a></li><li><a href="/en/basics/objects.html">Built-in Objects</a></li><li><a href="/en/basics/env.html">Environment</a></li><li><a href="/en/basics/config.html">Configuration</a></li><li><a href="/en/basics/middleware.html">Middleware</a></li><li><a href="/en/basics/router.html">Router</a></li><li><a href="/en/basics/controller.html">Controller</a></li><li><a href="/en/basics/service.html">Service</a></li><li><a href="/en/basics/schedule.html">Schedule</a></li><li><a href="/en/basics/extend.html">Extend</a></li><li><a href="/en/basics/app-start.html">Custom Init</a></li></ul></dd><dt>Core</dt><dd><ul><li><a href="/en/core/development.html">Development</a></li><li><a href="/en/core/unittest.html">Unit Testing</a></li><li><a href="/en/core/deployment.html">应用部署</a></li><li><a href="/en/core/logger.html">Logger</a></li><li><a href="/en/core/httpclient.html">HttpClient</a></li><li><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li><a href="/en/core/view.html">View</a></li><li><a href="/en/core/error-handling.html">Error Handling</a></li><li><a href="/en/core/security.html">Security</a></li><li><a href="/en/core/i18n.html">i18n</a></li></ul></dd><dt>Tutorials</dt><dd><ul><li><a href="/en/tutorials/progressive.html">Progressive</a></li><li><a href="/en/tutorials/mysql.html">MySQL</a></li><li><a href="/en/tutorials/restful.html">RESTful API</a></li><li><a href="/en/tutorials/async-function.html">Async Function</a></li></ul></dd><dt>Advanced</dt><dd><ul><li><a href="/en/advanced/loader.html">Loader</a></li><li><a href="/en/advanced/plugin.html">Plugin</a></li><li><a href="/en/advanced/framework.html">Framework</a></li><li><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li><a href="/en/advanced/view-plugin.html">View Plugin</a></li></ul></dd><dt>Community</dt><dd><ul><li><a href="/en/plugins/">内置插件列表</a></li><li><a href="/en/contributing.html">Contributing</a></li><li><a href="/en/resource.html">资源</a></li><li><a href="/en/faq.html">FAQ</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');
mobileTrigger.onclick = function(e) {
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'toc';
  }
};
</script>

</div>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script>
docsearch({
  apiKey: '1561de31a86f79507ea00cdb54ce647c',
  indexName: 'eggjs',
  inputSelector: '#search-query',
});
</script>
<div class="cnzz">
<script src="https://s11.cnzz.com/z_stat.php?id=1261142226&web_id=1261142226" language="JavaScript"></script>
</div>

</html>
