<!DOCTYPE html>
<html lang="en">
<head>
  <title>Development with Async Function - Born to build better enterprise frameworks and apps</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" href="/css/index.css">

</head>
<body>
  <div class="nav" >
  <header>
    <a href="/" class="nav-logo leftpadding" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li>
        <form id="search-form">
          <input type="text" id="search-query" class="search-query st-default-search-input">
        </form>
      </li>
      <li><a href="intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      <!--
      <li class="translations">
        <a class="nav-link">Translations</a>
        <span class="arrow"></span>
        <ul class="dropdown-content">
          <li><a href="/">中文</a></li>
          <li><a href="/">English</a></li>
        </ul>
      </li>
      -->
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <article class="markdown-body">
    <h1>Development with Async Function</h1>
    <p><a href="../intro/egg-and-koa.html#async-function">Previous chapter</a> introduces <a href="https://github.com/tc39/ecmascript-asyncawait" target="_blank" rel="external">async function</a> is a js language level's syntax that providing asynchronous solutions，and Node.js will upgrade v8 to version 5.5 since 7.6.0, then async function don't need to be enabled by flag. Framework default support async function，and can use async function to replace generator function.</p>
<p><strong>Note：When writing async function，make sure you are running on Node.js 7.6+.</strong></p>
<h2 id="controller-service"><a class="markdown-anchor" href="#controller-service">#</a> Controller &amp; Service</h2>
<p>In <a href="../basics/controller.html">controller</a>，there are two methods to write a controller：Controller Class and Method. Any implementations using generator function can use async function instead without logic change，just modify yield syntax to await.
Also in <a href="../basics/service.html">service</a> and <a href="../basics/controller.html">controller</a>，all async function can use async function to replace generator function。</p>
<p>For example, replacing codes in the <a href="../basics/controller.html">controller</a> with async function：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// app/controller/post.js</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">app</span>.<span class="title">Controller</span> </span>&#123;</div><div class="line">    <span class="comment">// replace * create() with async create()</span></div><div class="line">    <span class="keyword">async</span> create() &#123;</div><div class="line">      <span class="keyword">const</span> &#123; ctx, service &#125; = <span class="keyword">this</span>;</div><div class="line">      <span class="keyword">const</span> createRule = &#123;</div><div class="line">        title: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</div><div class="line">        content: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</div><div class="line">      &#125;;</div><div class="line">      <span class="comment">// vaildate parameters</span></div><div class="line">      ctx.validate(createRule);</div><div class="line">      <span class="comment">// assemble parameters</span></div><div class="line">      <span class="keyword">const</span> author = ctx.session.userId;</div><div class="line">      <span class="keyword">const</span> req = <span class="built_in">Object</span>.assign(ctx.request.body, &#123; author &#125;);</div><div class="line">      <span class="comment">// call service to handle business </span></div><div class="line">      <span class="comment">// replace yield with await</span></div><div class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> service.post.create(req);</div><div class="line">      <span class="comment">// set response content and status code</span></div><div class="line">      ctx.body = &#123; <span class="attr">id</span>: res.id &#125;;</div><div class="line">      ctx.status = <span class="number">201</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> PostController;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Note： Using await to call <code>service.post.create()</code>  in the controller, it might need be called after adjusting <code>service.post.create()</code> to async function if <code>service.post.create()</code> also use generator function</strong></p>
<h2 id="schedule"><a class="markdown-anchor" href="#schedule">#</a> Schedule</h2>
<p><a href="../basics/schedule.html">Schedule</a> also support async function，tasks need to follow the rules above to replace generator function with async function.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="comment">// config the schedule tasks through the attributes of schedule</span></div><div class="line">  schedule: &#123;</div><div class="line">    interval: <span class="string">'1m'</span>, <span class="comment">// 1 minute interval</span></div><div class="line">    type: <span class="string">'all'</span>, <span class="comment">// assign all workers are needed to execute</span></div><div class="line">  &#125;,</div><div class="line">  <span class="comment">// task is the function that running within schedule tasks, first parameter is instance of anonymous ctx</span></div><div class="line">  <span class="keyword">async</span> task(ctx) &#123;</div><div class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> ctx.curl(<span class="string">'http://www.api.com/cache'</span>, &#123;</div><div class="line">      dataType: <span class="string">'json'</span>,</div><div class="line">    &#125;);</div><div class="line">    ctx.app.cache = res.data;</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="middleware"><a class="markdown-anchor" href="#middleware">#</a> Middleware</h2>
<p>All middlewares，including <a href="../basics/middleware.html">Standard</a> and [Using Middleware in Router](../basics/router.md#Using Middleware) can be written with async function, but argument lists changed comparing to the middleware in generator function, similar to Koa v2.x：</p>
<ul>
<li>first parameter <code>ctx</code>，the request context，instance of <a href="../basics/extend.html#Context">Context</a> .</li>
<li>second parameter <code>next</code>，use await to execute the logic of middleware.</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// app/middleware/gzip.js</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> isJSON = <span class="built_in">require</span>(<span class="string">'koa-is-json'</span>);</div><div class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">'zlib'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">options, app</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">gzip</span>(<span class="params">ctx, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// next is a method and need to call comparing to the middleware with the generator function</span></div><div class="line">    <span class="keyword">await</span> next();</div><div class="line"></div><div class="line">    <span class="comment">// completed executing middleware then compress the response body to gzip</span></div><div class="line">    <span class="keyword">const</span> body = ctx.body;</div><div class="line">    <span class="keyword">if</span>（!body) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">// support options.threshold</span></div><div class="line">    <span class="keyword">if</span> (options.threshold &amp;&amp; ctx.length &lt; options.threshold) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isJSON(body)) body = <span class="built_in">JSON</span>.stringify(body);</div><div class="line"></div><div class="line">    <span class="comment">// set gzip body and revise the response header</span></div><div class="line">    ctx.body = zlib.createGzip().end(body);</div><div class="line">    ctx.set(<span class="string">'Content-Encoding'</span>, <span class="string">'gzip'</span>);</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="call-generator-function-api"><a class="markdown-anchor" href="#call-generator-function-api">#</a> Call generator function API</h2>
<p>Since some plugins providing the API of generator function that we cannot call async function using await directly. We can use <a href="https://github.com/tj/co" target="_blank" rel="external">co</a> to provide a wrap method to wrap them to return a Promise then can be used in async function.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</div><div class="line">app.mysql.query = co.wrap(app.mysql.query);</div><div class="line"><span class="comment">// need to bind this as app.mysql if want to use query directly</span></div><div class="line"><span class="keyword">const</span> query = co.wrap(app.mysql.query).bind(app.mysql);</div><div class="line"></div><div class="line"><span class="comment">// can use async function after wrapping</span></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// return await app.mysql.query();</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">await</span> query();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="slight-of-difference-with-generator-function"><a class="markdown-anchor" href="#slight-of-difference-with-generator-function">#</a> Slight of Difference with Generator Function</h2>
<p>While both functions are exactly the same models, but <a href="https://github.com/tj/co" target="_blank" rel="external">co</a> has some special handling such as supporting yield an array (object), which are not native in the async function. But you can easily implement these functions based on some Promise libraries and methods.</p>
<ul>
<li>
<p>generator function</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> tasks = [ task(<span class="number">1</span>), task(<span class="number">2</span>), task(<span class="number">3</span>) ];</div><div class="line">  <span class="keyword">let</span> results;</div><div class="line">  <span class="comment">// concurrency</span></div><div class="line">  results = <span class="keyword">yield</span> tasks;</div><div class="line">  <span class="comment">// set max concurrent as 2 </span></div><div class="line">  result = <span class="keyword">yield</span> <span class="built_in">require</span>(<span class="string">'co-parallel'</span>)(tasks, <span class="number">2</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li>
<p>async function</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">async</span> () =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> tasks = [ task(<span class="number">1</span>), task(<span class="number">2</span>), task(<span class="number">3</span>) ];</div><div class="line">  <span class="keyword">let</span> results;</div><div class="line">  <span class="comment">// concurrency</span></div><div class="line">  results = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(tasks);</div><div class="line">  <span class="comment">// set max concurrent as 2 </span></div><div class="line">  results = <span class="keyword">await</span> <span class="built_in">require</span>(<span class="string">'p-all'</span>)(tasks, &#123; <span class="attr">concurrency</span>: <span class="number">2</span>&#125; );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>@sindresorhus writing lots of <a href="https://github.com/sindresorhus/promise-fun" target="_blank" rel="external">helpers based on promise</a>，flexible use with async function can make code more readable.</p>
<hr>
<p>Full examples refer to  <a href="https://github.com/eggjs/examples/tree/master/hackernews-async" target="_blank" rel="external">examples/hackernews-async</a>.</p>

  </article>
  <aside id="mobileAside" class="toc">
  <div class="mobile-menu">
    <ul><li><a href="intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li></ul>
  </div>
  <dl><dt>Guide</dt><dd><ul><li><a href="/en/intro/index.html">What is Egg?</a></li><li><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li><a href="/en/intro/quickstart.html">Quick Start</a></li></ul></dd><dt>Basis Function</dt><dd><ul><li><a href="/en/basics/structure.html">Directory Structure</a></li><li><a href="/en/basics/objects.html">Built-in Objects</a></li><li><a href="/en/basics/env.html">Environment</a></li><li><a href="/en/basics/config.html">Configuration</a></li><li><a href="/en/basics/middleware.html">Middleware</a></li><li><a href="/en/basics/router.html">Router</a></li><li><a href="/en/basics/controller.html">Controller</a></li><li><a href="/en/basics/service.html">Service</a></li><li><a href="/en/basics/schedule.html">Schedule</a></li><li><a href="/en/basics/extend.html">Extend</a></li><li><a href="/en/basics/app-start.html">Custom Init</a></li></ul></dd><dt>Core</dt><dd><ul><li><a href="/en/core/development.html">Development</a></li><li><a href="/en/core/unittest.html">Unit Testing</a></li><li><a href="/en/core/deployment.html">应用部署</a></li><li><a href="/en/core/logger.html">Logger</a></li><li><a href="/en/core/httpclient.html">HttpClient</a></li><li><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li><a href="/en/core/view.html">View</a></li><li><a href="/en/core/error-handling.html">Error Handling</a></li><li><a href="/en/core/security.html">Security</a></li><li><a href="/en/core/i18n.html">i18n</a></li></ul></dd><dt>Tutorials</dt><dd><ul><li><a href="/en/tutorials/progressive.html">Progressive</a></li><li><a href="/en/tutorials/mysql.html">MySQL</a></li><li><a href="/en/tutorials/restful.html">RESTful API</a></li><li><a href="/en/tutorials/async-function.html">Async Function</a></li></ul></dd><dt>Advanced</dt><dd><ul><li><a href="/en/advanced/loader.html">Loader</a></li><li><a href="/en/advanced/plugin.html">Plugin</a></li><li><a href="/en/advanced/framework.html">Framework</a></li><li><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li><a href="/en/advanced/view-plugin.html">View Plugin</a></li></ul></dd><dt>Community</dt><dd><ul><li><a href="/en/plugins/">内置插件列表</a></li><li><a href="/en/contributing.html">Contributing</a></li><li><a href="/en/resource.html">资源</a></li><li><a href="/en/faq.html">FAQ</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');
mobileTrigger.onclick = function(e) {
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'toc';
  }
};
</script>

</div>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script>
docsearch({
  apiKey: '1561de31a86f79507ea00cdb54ce647c',
  indexName: 'eggjs',
  inputSelector: '#search-query',
});
</script>
<div class="cnzz">
<script src="https://s11.cnzz.com/z_stat.php?id=1261142226&web_id=1261142226" language="JavaScript"></script>
</div>

</html>
